<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>{{ playlist.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container" style="padding-bottom:120px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="/" class="pill-btn ghost">‚¨Ö Retour</a>
            <button id="devices-open" class="icon-btn" aria-label="Devices" type="button">
                <img src="/static/img/devices.png" alt="Devices">
            </button>
        </div>
        <h1>{{ playlist.name }}</h1>
        <p>üé∂ {{ playlist.tracks.total }} titres</p>
        <div style="display:flex; gap:10px; margin-bottom:14px;">
            <button
                onclick='playPlaylistAndUpdateRecent({{ tracks|tojson }}, "{{ playlist.name }}", "{{ playlist.images[0].url if playlist.images else "" }}")'
                class="pill-btn">‚ñ∂Ô∏è Play Playlist</button>
            <button onclick='downloadPlaylist({{ tracks|tojson }})' class="pill-btn ghost">‚¨áÔ∏è Tout t√©l√©charger</button>
        </div>
        <table class="tracklist">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nom</th>
                    <th>Artiste</th>
                    <th>Album</th>
                    <th>Dur√©e</th>
                    <th>Play</th>
                    <th>Download</th>
                </tr>
            </thead>
            <tbody>
                {% for track in tracks %}
                <tr>
                    <td>{{ track['Track Number'] }}</td>
                    <td>{{ track['Track Name'] }}</td>
                    <td>{{ track['Artist Name(s)'] }}</td>
                    <td>{{ track['Album Name'] }}</td>
                    <td>{{ (track['Track Duration (ms)']|int // 60000) }}:{{ '%02d' % ((track['Track Duration (ms)']|int
                        // 1000) % 60) }}</td>
                    <td><button onclick='playCSVTrack({{ track|tojson }})'>‚ñ∂Ô∏è</button></td>
                    <td><button
                            onclick='downloadTrack("", "{{ track["Track Name"] }}", "{{ track["Artist Name(s)"] }}")'>‚¨áÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="player-bar">

        <!-- Gauche : pochette + infos -->
        <div class="track-left">
            <img id="track-cover" src="{{ url_for('static', filename='/img/default_cover.jpg') }}" alt="Cover"
                onerror="this.src='/static/img/default_cover.jpg'">
            <div id="track-info">Aucun titre s√©lectionn√©</div>
        </div>

        <!-- Centre : contr√¥les principaux -->
        <div class="controls">
            <div class="controls">
                <button id="shuffle"><img src="/static/img/shuffle.png" alt="Shuffle"></button>
                <button id="prev"><img src="/static/img/skip_previous.png" alt="Previous"></button>
                <button id="play"><img src="/static/img/play.png" alt="Play"></button>
                <button id="next"><img src="/static/img/skip_next.png" alt="Next"></button>
                <button id="repeat"><img src="/static/img/repeat.png" alt="Repeat"></button>
                <button id="queue-btn"><img src="/static/img/queued_music.png" alt="Queue"></button>
            </div>

        </div>

        <!-- Droite : volume -->
        <div class="volume">
            <span>üîä</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
        </div>

        <!-- Barre de progression tout en bas -->
        <div class="progress-container">
            <span id="current-time">0:00</span>
            <input type="range" id="progress" value="0" min="0" max="100" step="0.1">
            <span id="duration">0:00</span>
        </div>

        <audio id="audio-player"></audio>
    </div>

    </div>

    <!-- Devices Overlay (Copied from index.html) -->
    <div id="devices-overlay" class="overlay hidden">
        <div class="devices-panel">
            <div class="devices-header">
                <h3>Devices</h3>
                <button id="devices-close" class="pill-btn ghost">Fermer</button>
            </div>
            <div class="devices-search">
                <input id="device-input" placeholder="IP:PORT (ex: 192.168.1.50:5000)">
                <button id="device-scan" class="pill-btn">Ajouter</button>
            </div>
            <div id="devices-list" class="devices-list"></div>
            <div id="device-actions" class="devices-actions hidden">
                <div class="devices-actions-header">
                    <strong id="device-name">Appareil</strong>
                    <span id="device-type" class="status-pill">Type</span>
                </div>

                <div id="remote-music-info" class="remote-music-info hidden">
                    <div class="remote-track-title" id="remote-music-title">-</div>
                    <div class="remote-track-time" id="remote-music-time">--:-- / --:--</div>
                </div>

                <div id="device-remote" class="devices-remote hidden">
                    <button data-action="previous" class="pill-btn ghost">Previous</button>
                    <button data-action="play_pause" class="pill-btn">Play / Pause</button>
                    <button data-action="next" class="pill-btn ghost">Next</button>
                </div>
                <div class="devices-playlist">
                    <div class="devices-playlist-header">
                        <span>Playlist distante</span>
                        <div class="devices-playlist-actions">
                            <button id="remote-add-current" class="pill-btn">Ajouter le titre actuel</button>
                            <button id="remote-refresh" class="pill-btn ghost">Rafra√Æchir</button>
                        </div>
                    </div>
                    <div id="remote-playlist" class="remote-playlist"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function playPlaylistAndUpdateRecent(tracks, playlistName, playlistImage) {
            playPlaylist(tracks, 0);

            // Add to recent
            fetch("/update_recent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    type: "playlist",
                    title: playlistName,
                    id: playlistName,
                    image: playlistImage,
                    url: playlistName
                })
            });
        }

        async function downloadPlaylist(tracks) {
            if (!confirm("T√©l√©charger " + tracks.length + " titres ? Cela peut prendre du temps.")) return;

            const btn = document.querySelector('button[onclick^="downloadPlaylist"]');
            const originalText = btn.textContent;

            for (let i = 0; i < tracks.length; i++) {
                const t = tracks[i];
                btn.textContent = `‚è≥ ${i + 1}/${tracks.length}`;

                // Use existing downloadTrack but force cache=1 (so it's available locally/cache)
                // We can reuse the logic: call /get_track_path which does download(cache=1) if needed?
                // Or call /download?cache=1 directly.
                // Let's use /get_track_path to be safe and get metadata logic.

                try {
                    await fetch("/get_track_path", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(t)
                    });
                } catch (e) {
                    console.error("Failed to download", t['Track Name']);
                }
            }

            btn.textContent = "‚úÖ Termin√© !";
            setTimeout(() => btn.textContent = originalText, 3000);
        }
    </script>

    <script src="{{ url_for('static', filename='devices.js') }}"></script>
    <script src="{{ url_for('static', filename='player.js') }}"></script>
    <script src="{{ url_for('static', filename='player2.js') }}"></script>

    <!-- Queue Modal -->
    <div id="queue-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; color:black;">
        <div style="background:white; margin:10% auto; width:80%; max-width:600px; padding:20px; border-radius:10px;">
            <h3>File d'attente (Queue)</h3>
            <input id="add-queue-input" placeholder="Rechercher et ajouter une musique" style="width:70%; padding:5px;">
            <button id="add-queue-btn" style="padding:5px;">Ajouter</button>
            <ul id="queue-list" style="list-style:none; padding:0; max-height:300px; overflow-y:auto;"></ul>
            <button id="close-queue" style="margin-top:10px; padding:5px;">Fermer</button>
        </div>
    </div>
</body>

</html>